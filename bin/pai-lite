#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks to find real script location
script_path="${BASH_SOURCE[0]}"
while [[ -L "$script_path" ]]; do
  script_dir="$(cd "$(dirname "$script_path")" && pwd)"
  script_path="$(readlink "$script_path")"
  # Handle relative symlinks
  [[ "$script_path" != /* ]] && script_path="$script_dir/$script_path"
done
root_dir="$(cd "$(dirname "$script_path")/.." && pwd)"

# shellcheck source=lib/common.sh
source "$root_dir/lib/common.sh"
# shellcheck source=lib/slots.sh
source "$root_dir/lib/slots.sh"
# shellcheck source=lib/tasks.sh
source "$root_dir/lib/tasks.sh"
# shellcheck source=lib/triggers.sh
source "$root_dir/lib/triggers.sh"
# shellcheck source=lib/flow.sh
source "$root_dir/lib/flow.sh"
# shellcheck source=lib/notify.sh
source "$root_dir/lib/notify.sh"

usage() {
  cat <<'USAGE'
Usage: pai-lite <command>

Commands:
  slots                        Show all slots
  slot <n>                     Show slot n
  slot <n> assign <task>       Assign a task to slot n
  slot <n> clear               Clear slot n
  slot <n> start               Start agent session (adapter)
  slot <n> stop                Stop agent session (adapter)
  slot <n> note "text"         Add runtime note to slot n

  tasks sync                   Aggregate tasks from sources
  tasks list                   Show unified task list
  tasks show <id>              Show task details
  tasks convert                Convert tasks.yaml to individual task files
  tasks create <title>         Create a new task manually
  tasks files                  List individual task files
  tasks samples                Create sample tasks for testing

  flow ready                   Priority-sorted ready tasks
  flow blocked                 What's blocked and why
  flow critical                Deadlines + stalled + high-priority
  flow impact <id>             What this task unblocks
  flow context                 Context distribution across slots
  flow check-cycle             Check for dependency cycles

  mayor briefing               Request morning briefing
  mayor suggest                Get task suggestions
  mayor analyze <issue>        Analyze GitHub issue
  mayor elaborate <id>         Elaborate task into detailed spec
  mayor health-check           Check for stalled work, deadlines

  notify pai <msg>             Send strategic notification
  notify agents <msg>          Send operational notification
  notify public <msg>          Send public broadcast
  notify recent [n]            Show recent notifications

  status                       Overview of slots + tasks
  briefing                     Morning briefing
  init                         Initialize config + harness
  triggers install             Install launchd/systemd triggers
  triggers status              Show trigger status
  triggers uninstall           Remove all triggers
  doctor                       Check system health and dependencies

  help                         Show this message
USAGE
}

require_config() {
  local config
  config="$(pai_lite_config_path)"
  [[ -f "$config" ]] || pai_lite_die "config not found: $config (run: pai-lite init)"
}

cmd="${1:-}"
case "$cmd" in
  help|-h|--help|"")
    usage
    exit 0
    ;;
  init)
    # Install to ~/.local/pai-lite with symlink in ~/.local/bin
    local_install="$HOME/.local/pai-lite"
    local_bin="$HOME/.local/bin"

    # Copy entire directory structure
    mkdir -p "$local_install"
    cp -r "$root_dir"/{bin,lib,adapters,templates} "$local_install/"

    # Create symlink in ~/.local/bin
    mkdir -p "$local_bin"
    ln -sf "$local_install/bin/pai-lite" "$local_bin/pai-lite"

    echo "Installed pai-lite to $local_install"
    echo "Symlinked $local_bin/pai-lite -> $local_install/bin/pai-lite"

    # Check if ~/.local/bin is in PATH
    if [[ ":$PATH:" != *":$local_bin:"* ]]; then
      pai_lite_warn "$local_bin is not in PATH; add it to your shell profile:"
      echo "  export PATH=\"\$PATH:$local_bin\""
    fi

    config_path="$(pai_lite_config_path)"
    config_dir="$(dirname "$config_path")"
    mkdir -p "$config_dir"

    if [[ -f "$config_path" ]]; then
      pai_lite_warn "config already exists: $config_path"
    else
      cp "$root_dir/templates/config.example.yaml" "$config_path"
      echo "Created config: $config_path"
    fi

    if [[ -f "$config_path" ]]; then
      state_repo="$(pai_lite_state_repo_slug)"
      if [[ "$state_repo" == *"your-username"* ]]; then
        pai_lite_warn "config still uses placeholder state_repo; update it before cloning"
      else
        pai_lite_ensure_state_repo
        pai_lite_ensure_state_dir
        harness_dir="$(pai_lite_state_harness_dir)"
        if [[ ! -f "$harness_dir/config.yaml" ]]; then
          cp "$root_dir/templates/harness/config.yaml" "$harness_dir/config.yaml"
        fi
        if [[ ! -f "$harness_dir/slots.md" ]]; then
          cp "$root_dir/templates/harness/slots.md" "$harness_dir/slots.md"
        fi
        echo "Initialized harness in: $harness_dir"
      fi
    fi
    ;;
  slots)
    require_config
    slots_list
    ;;
  slot)
    require_config
    slot_num="${2:-}"
    [[ -n "$slot_num" ]] || pai_lite_die "slot number required"
    action="${3:-}"
    case "$action" in
      "")
        slot_show "$slot_num"
        ;;
      assign)
        shift 3
        [[ -n "${*:-}" ]] || pai_lite_die "task description required"
        slot_assign "$slot_num" "$*"
        ;;
      clear)
        slot_clear "$slot_num"
        ;;
      start)
        slot_start "$slot_num"
        ;;
      stop)
        slot_stop "$slot_num"
        ;;
      note)
        shift 3
        [[ -n "${*:-}" ]] || pai_lite_die "note text required"
        slot_note "$slot_num" "$*"
        ;;
      *)
        pai_lite_die "unknown slot action: $action"
        ;;
    esac
    ;;
  tasks)
    require_config
    sub="${2:-}"
    case "$sub" in
      sync)
        tasks_sync
        ;;
      list)
        tasks_list
        ;;
      show)
        task_id="${3:-}"
        [[ -n "$task_id" ]] || pai_lite_die "task id required"
        tasks_show "$task_id"
        ;;
      convert)
        tasks_convert
        ;;
      create)
        shift 2
        [[ -n "${1:-}" ]] || pai_lite_die "task title required"
        title="$1"
        project="${2:-personal}"
        priority="${3:-B}"
        tasks_create "$title" "$project" "$priority"
        ;;
      files)
        tasks_files_list
        ;;
      samples)
        tasks_create_samples
        ;;
      *)
        pai_lite_die "unknown tasks subcommand: $sub (use: sync, list, show, convert, create, files, samples)"
        ;;
    esac
    ;;
  status)
    require_config
    echo "Slots:"
    slots_list || true
    echo ""
    if [[ -f "$(tasks_file_path)" ]]; then
      echo "Tasks:"
      tasks_list | head -n 10
    else
      echo "Tasks: (run 'pai-lite tasks sync')"
    fi
    ;;
  briefing)
    require_config
    echo "pai-lite briefing - $(date)"
    echo ""
    echo "Slots:"
    slots_list || true
    echo ""
    if [[ -f "$(tasks_file_path)" ]]; then
      echo "Tasks:"
      tasks_list
    else
      echo "Tasks: (run 'pai-lite tasks sync')"
    fi
    ;;
  triggers)
    require_config
    sub="${2:-}"
    case "$sub" in
      install)
        triggers_install
        ;;
      status)
        triggers_status
        ;;
      uninstall)
        triggers_uninstall
        ;;
      *)
        pai_lite_die "unknown triggers subcommand: $sub (use: install, status, uninstall)"
        ;;
    esac
    ;;
  flow)
    require_config
    shift
    flow_main "$@"
    ;;
  mayor)
    require_config
    sub="${2:-}"
    case "$sub" in
      briefing)
        request_id=$(pai_lite_queue_request "briefing")
        echo "Queued briefing request: $request_id"
        echo "Mayor will process when ready (check ~/.claude/hooks/on-stop.sh)"
        ;;
      suggest)
        request_id=$(pai_lite_queue_request "suggest")
        echo "Queued suggestion request: $request_id"
        ;;
      analyze)
        issue="${3:-}"
        [[ -n "$issue" ]] || pai_lite_die "issue number or URL required"
        request_id=$(pai_lite_queue_request "analyze-issue" "\"issue\":\"$issue\"")
        echo "Queued issue analysis: $request_id"
        ;;
      elaborate)
        task_id="${3:-}"
        [[ -n "$task_id" ]] || pai_lite_die "task id required"
        request_id=$(pai_lite_queue_request "elaborate" "\"task\":\"$task_id\"")
        echo "Queued task elaboration: $request_id"
        ;;
      health-check)
        request_id=$(pai_lite_queue_request "health-check")
        echo "Queued health check: $request_id"
        ;;
      queue)
        # Show pending queue
        queue_file="$(pai_lite_queue_file)"
        if [[ -f "$queue_file" ]] && [[ -s "$queue_file" ]]; then
          echo "Pending requests:"
          cat "$queue_file"
        else
          echo "No pending requests in queue"
        fi
        ;;
      *)
        pai_lite_die "unknown mayor subcommand: $sub (use: briefing, suggest, analyze, elaborate, health-check, queue)"
        ;;
    esac
    ;;
  notify)
    require_config
    sub="${2:-}"
    case "$sub" in
      pai)
        shift 2
        [[ -n "${*:-}" ]] || pai_lite_die "message required"
        notify_pai "$*"
        echo "Notification sent to pai topic"
        ;;
      agents)
        shift 2
        [[ -n "${*:-}" ]] || pai_lite_die "message required"
        notify_agents "$*"
        echo "Notification sent to agents topic"
        ;;
      public)
        shift 2
        [[ -n "${*:-}" ]] || pai_lite_die "message required"
        notify_public "$*"
        echo "Notification sent to public topic"
        ;;
      recent)
        count="${3:-10}"
        notify_recent "$count"
        ;;
      *)
        pai_lite_die "unknown notify subcommand: $sub (use: pai, agents, public, recent)"
        ;;
    esac
    ;;
  doctor)
    # Comprehensive health check
    echo "pai-lite doctor - system health check"
    echo "======================================"
    echo ""

    all_ok=true
    warnings=0

    #------------------------------------------
    # Required tools
    #------------------------------------------
    echo "Required tools:"

    # git
    if command -v git >/dev/null 2>&1; then
      echo "  [ok] git: $(git --version | head -1)"
    else
      echo "  [FAIL] git: NOT FOUND"
      all_ok=false
    fi

    # gh (GitHub CLI)
    if command -v gh >/dev/null 2>&1; then
      echo "  [ok] gh: $(gh --version | head -1)"
      # Check auth status
      if gh auth status >/dev/null 2>&1; then
        echo "    -> authenticated"
      else
        echo "    -> [warn] not authenticated (run: gh auth login)"
        warnings=$((warnings + 1))
      fi
    else
      echo "  [FAIL] gh: NOT FOUND"
      echo "    Install: https://cli.github.com/"
      all_ok=false
    fi

    # yq
    if command -v yq >/dev/null 2>&1; then
      echo "  [ok] yq: $(yq --version 2>&1 | head -1)"
    else
      echo "  [FAIL] yq: NOT FOUND"
      echo "    Install: brew install yq"
      all_ok=false
    fi

    # jq
    if command -v jq >/dev/null 2>&1; then
      echo "  [ok] jq: $(jq --version)"
    else
      echo "  [FAIL] jq: NOT FOUND"
      echo "    Install: brew install jq"
      all_ok=false
    fi

    # curl
    if command -v curl >/dev/null 2>&1; then
      echo "  [ok] curl: $(curl --version | head -1)"
    else
      echo "  [FAIL] curl: NOT FOUND"
      all_ok=false
    fi

    echo ""

    #------------------------------------------
    # Optional tools
    #------------------------------------------
    echo "Optional tools:"

    # tmux
    if command -v tmux >/dev/null 2>&1; then
      echo "  [ok] tmux: $(tmux -V)"
    else
      echo "  [warn] tmux: not found (needed for claude-code/codex adapters)"
      echo "    Install: brew install tmux"
      warnings=$((warnings + 1))
    fi

    # ttyd
    if command -v ttyd >/dev/null 2>&1; then
      echo "  [ok] ttyd: $(ttyd --version 2>&1 | head -1)"
    else
      echo "  [warn] ttyd: not found (optional web terminal access)"
      echo "    Install: brew install ttyd"
      warnings=$((warnings + 1))
    fi

    # tsort (usually part of coreutils)
    if command -v tsort >/dev/null 2>&1; then
      echo "  [ok] tsort: available"
    else
      echo "  [warn] tsort: not found (needed for flow dependency analysis)"
      warnings=$((warnings + 1))
    fi

    # shellcheck
    if command -v shellcheck >/dev/null 2>&1; then
      echo "  [ok] shellcheck: $(shellcheck --version | grep version:)"
    else
      echo "  [warn] shellcheck: not found (for development)"
      warnings=$((warnings + 1))
    fi

    echo ""

    #------------------------------------------
    # Configuration
    #------------------------------------------
    echo "Configuration:"

    config_path="$(pai_lite_config_path 2>/dev/null || echo "")"
    pointer_path="$(pai_lite_pointer_config_path)"

    if [[ -n "$config_path" && -f "$config_path" ]]; then
      echo "  [ok] config: $config_path"

      # Check state repo
      state_repo="$(pai_lite_state_repo_slug 2>/dev/null || echo "")"
      if [[ -n "$state_repo" && "$state_repo" != *"your-username"* ]]; then
        echo "    -> state_repo: $state_repo"

        # Check if state repo is cloned
        state_dir="$(pai_lite_state_repo_dir 2>/dev/null || echo "")"
        if [[ -n "$state_dir" && -d "$state_dir/.git" ]]; then
          echo "    -> state dir: $state_dir (exists)"
        else
          echo "    -> [warn] state dir: not cloned"
          warnings=$((warnings + 1))
        fi
      else
        echo "    -> [warn] state_repo: using placeholder value"
        warnings=$((warnings + 1))
      fi
    else
      echo "  [warn] config: not found at $pointer_path"
      echo "    Run: pai-lite init"
      warnings=$((warnings + 1))
    fi

    echo ""

    #------------------------------------------
    # Adapters
    #------------------------------------------
    echo "Adapter checks:"

    # Source adapters for doctor functions
    for adapter_file in "$root_dir"/adapters/*.sh; do
      [[ -f "$adapter_file" ]] || continue
      adapter_name="$(basename "$adapter_file" .sh)"

      # Skip manual adapter (no tools needed)
      [[ "$adapter_name" == "manual" ]] && continue

      # shellcheck source=/dev/null
      source "$adapter_file" 2>/dev/null || continue

      # Check if adapter has doctor function
      doctor_func="adapter_${adapter_name//-/_}_doctor"
      if declare -f "$doctor_func" >/dev/null 2>&1; then
        echo ""
        echo "--- $adapter_name ---"
        if ! "$doctor_func"; then
          all_ok=false
        fi
      fi
    done

    echo ""

    #------------------------------------------
    # Triggers
    #------------------------------------------
    echo "Triggers:"
    uname_out="$(uname -s)"
    case "$uname_out" in
      Darwin)
        # Count triggers; use || true to handle missing directory
        trigger_count=$( (find "$HOME/Library/LaunchAgents" -maxdepth 1 -name 'com.pai-lite.*.plist' 2>/dev/null || true) | wc -l | tr -d ' ')
        if [[ "$trigger_count" -gt 0 ]]; then
          echo "  [ok] launchd: $trigger_count trigger(s) installed"
        else
          echo "  [warn] launchd: no triggers installed"
          echo "    Run: pai-lite triggers install"
          warnings=$((warnings + 1))
        fi
        ;;
      Linux)
        if command -v systemctl >/dev/null 2>&1; then
          # Count triggers; use || true to handle missing directory
          trigger_count=$( (find "$HOME/.config/systemd/user" -maxdepth 1 -name 'pai-lite-*.service' 2>/dev/null || true) | wc -l | tr -d ' ')
          if [[ "$trigger_count" -gt 0 ]]; then
            echo "  [ok] systemd: $trigger_count trigger(s) installed"
          else
            echo "  [warn] systemd: no triggers installed"
            echo "    Run: pai-lite triggers install"
            warnings=$((warnings + 1))
          fi
        else
          echo "  [warn] systemctl not available"
        fi
        ;;
    esac

    echo ""

    #------------------------------------------
    # Notifications
    #------------------------------------------
    echo "Notifications:"
    pai_topic="$(pai_lite_config_notifications_topic "pai" 2>/dev/null || echo "")"
    if [[ -n "$pai_topic" ]]; then
      echo "  [ok] ntfy.sh topics configured"
      echo "    -> pai: $pai_topic"
      agents_topic="$(pai_lite_config_notifications_topic "agents" 2>/dev/null || echo "")"
      [[ -n "$agents_topic" ]] && echo "    -> agents: $agents_topic"
      public_topic="$(pai_lite_config_notifications_topic "public" 2>/dev/null || echo "")"
      [[ -n "$public_topic" ]] && echo "    -> public: $public_topic"
    else
      echo "  [warn] ntfy.sh topics not configured"
      warnings=$((warnings + 1))
    fi

    echo ""

    #------------------------------------------
    # Summary
    #------------------------------------------
    echo "======================================"
    if $all_ok && [[ $warnings -eq 0 ]]; then
      echo "[OK] All checks passed"
      exit 0
    elif $all_ok; then
      echo "[OK] Required checks passed ($warnings warning(s))"
      exit 0
    else
      echo "[FAIL] Some required checks failed ($warnings warning(s))"
      exit 1
    fi
    ;;
  *)
    pai_lite_die "unknown command: $cmd"
    ;;
esac
