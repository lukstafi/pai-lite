<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ludics Tasks</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .tasks-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            width: 100%;
        }

        .tasks-panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            min-height: 300px;
        }

        .tasks-panel h2 {
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .tasks-forest {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .tree-node {
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .tree-node.highlighted {
            border-color: var(--accent);
        }

        .tree-node > summary {
            cursor: pointer;
            list-style: none;
            padding: 0.45rem 0.6rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            user-select: none;
        }

        .tree-node > summary::-webkit-details-marker {
            display: none;
        }

        .tree-node > summary::before {
            content: ">";
            display: inline-block;
            width: 1rem;
            color: var(--text-secondary);
        }

        .tree-node[open] > summary::before {
            content: "v";
        }

        .tree-node.project > summary {
            background-color: var(--bg-secondary);
            font-weight: 600;
        }

        .tree-node.task > summary {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .tree-node.highlighted > summary {
            background-color: rgba(233, 69, 96, 0.08);
        }

        .tree-node.has-proposal > summary {
            background-color: rgba(233, 69, 96, 0.2);
            color: #fff;
        }

        .node-body {
            padding: 0.5rem 0.6rem 0.6rem 1.4rem;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .task-link-row {
            margin: 0;
            font-size: 0.82rem;
            color: var(--text-secondary);
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .task-link-row a {
            color: var(--accent);
            text-decoration: none;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .task-link-row a:hover {
            text-decoration: underline;
        }

        .task-badge {
            font-size: 0.72rem;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.08rem 0.35rem;
        }

        .tasks-placeholder {
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-links">
            <h1>ludics</h1>
            <a href="index.html">Dashboard</a>
            <a href="terminals.html">Terminals</a>
            <a href="tasks.html" class="active">Tasks</a>
            <a href="briefing.html">Briefing</a>
        </div>
        <div class="status-bar">
            <span id="last-update">Last update: --</span>
            <span id="connection-status" class="connected">Connected</span>
        </div>
    </header>

    <main class="tasks-container">
        <section class="tasks-panel">
            <h2>Tasks</h2>
            <div id="tasks-forest" class="tasks-forest">
                <p class="tasks-placeholder">Loading task tree...</p>
            </div>
        </section>
    </main>

    <footer>
        <p>ludics v0.1 | <a href="https://github.com/lukstafi/ludics">GitHub</a></p>
    </footer>

    <script>
        const CONFIG = {
            refreshInterval: 10000,
            dataPath: 'data/'
        };
        let openNodeKeys = new Set();
        let hasRendered = false;

        document.addEventListener('DOMContentLoaded', () => {
            fetchTasksTree();
            setInterval(fetchTasksTree, CONFIG.refreshInterval);
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                fetchTasksTree();
            }
        });

        async function fetchTasksTree() {
            try {
                const response = await fetch(CONFIG.dataPath + 'tasks-tree.json');
                if (!response.ok) throw new Error('Failed to fetch task tree');
                const tree = await response.json();
                renderTasksTree(tree);
                updateTimestamp();
                setConnectionStatus(true);
            } catch (error) {
                console.warn('Failed to fetch task tree:', error);
                setConnectionStatus(false);
            }
        }

        function renderTasksTree(forest) {
            const container = document.getElementById('tasks-forest');
            if (!container) return;

            // Capture current expansion state before rebuilding.
            const currentlyOpen = new Set();
            container.querySelectorAll('details.tree-node[open]').forEach((el) => {
                if (el.dataset.nodeKey) currentlyOpen.add(el.dataset.nodeKey);
            });
            if (currentlyOpen.size > 0) {
                openNodeKeys = currentlyOpen;
            }

            if (!Array.isArray(forest) || forest.length === 0) {
                container.innerHTML = '<p class="tasks-placeholder">No tasks found</p>';
                return;
            }

            container.innerHTML = '';
            for (let i = 0; i < forest.length; i++) {
                container.appendChild(renderNode(forest[i], 0, 'root', i));
            }
            hasRendered = true;
        }

        function renderNode(node, depth, parentKey, index) {
            const nodeKey = `${parentKey}/${node.kind || 'task'}:${node.id || '(no-id)'}:${index}`;
            const details = document.createElement('details');
            details.className = `tree-node ${node.kind || 'task'}`;
            if (node.highlighted) details.classList.add('highlighted');
            if (node.hasProposal) details.classList.add('has-proposal');
            details.dataset.nodeKey = nodeKey;
            if (openNodeKeys.has(nodeKey) || (!hasRendered && depth === 0)) details.open = true;

            const summary = document.createElement('summary');
            summary.textContent = node.title || node.id || '(untitled)';
            details.appendChild(summary);

            const body = document.createElement('div');
            body.className = 'node-body';

            if (node.kind === 'task') {
                const row = document.createElement('p');
                row.className = 'task-link-row';

                const taskLink = document.createElement('a');
                taskLink.textContent = node.id || '(no id)';
                taskLink.href = node.link || '#';
                taskLink.target = '_blank';
                taskLink.rel = 'noopener noreferrer';
                row.appendChild(taskLink);

                if (node.proposalLink) {
                    const proposalLink = document.createElement('a');
                    proposalLink.textContent = 'proposal';
                    proposalLink.href = node.proposalLink;
                    proposalLink.target = '_blank';
                    proposalLink.rel = 'noopener noreferrer';
                    row.appendChild(proposalLink);
                }

                if (node.priority) {
                    const priority = document.createElement('span');
                    priority.className = 'task-badge';
                    priority.textContent = `P${node.priority}`;
                    row.appendChild(priority);
                }

                if (node.status) {
                    const status = document.createElement('span');
                    status.className = 'task-badge';
                    status.textContent = node.status;
                    row.appendChild(status);
                }

                if (node.hasProposal) {
                    const proposal = document.createElement('span');
                    proposal.className = 'task-badge';
                    proposal.textContent = 'proposal';
                    row.appendChild(proposal);
                }

                body.appendChild(row);
            }

            const children = Array.isArray(node.children) ? node.children : [];
            for (let i = 0; i < children.length; i++) {
                body.appendChild(renderNode(children[i], depth + 1, nodeKey, i));
            }

            details.appendChild(body);
            return details;
        }

        function updateTimestamp() {
            const el = document.getElementById('last-update');
            if (el) {
                el.textContent = `Last update: ${formatTime(new Date().toISOString())}`;
            }
        }

        function setConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            if (!el) return;
            el.className = connected ? 'connected' : 'disconnected';
            el.textContent = connected ? 'Connected' : 'Disconnected';
        }

        function formatTime(isoString) {
            if (!isoString) return '--';
            try {
                const date = new Date(isoString);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;

                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString;
            }
        }
    </script>
</body>
</html>
